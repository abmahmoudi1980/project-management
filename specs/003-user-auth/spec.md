# Feature Specification: احراز هویت کاربر (User Authentication)

**Feature Branch**: `003-user-auth`  
**Created**: 2025-12-30  
**Status**: Draft  
**Input**: User description: "I want to add user authentication to this project. For this purpose, two roles should be considered for users: Admin and Regular user. A form should be added for user registration, a form should be added for user login, and a form for forgetting password. Note: The main language of the system is Persian, so all labels should be Persian"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ثبت‌نام کاربر جدید (User Registration) (Priority: P1)

کاربر جدیدی که می‌خواهد از سیستم استفاده کند، باید بتواند حساب کاربری خود را ایجاد کند. این کاربر در ابتدا با نقش "کاربر عادی" ثبت می‌شود و پس از تکمیل فرآیند ثبت‌نام، می‌تواند وارد سیستم شود.

**Why this priority**: بدون قابلیت ثبت‌نام، کاربران جدید نمی‌توانند از سیستم استفاده کنند. این اولین گام در چرخه عمر کاربر است.

**Independent Test**: می‌توان با ایجاد فرم ثبت‌نام و ذخیره اطلاعات کاربر در سیستم، این قابلیت را به صورت مستقل تست کرد. موفقیت در ثبت‌نام با ایجاد حساب کاربری جدید قابل سنجش است.

**Acceptance Scenarios**:

1. **Given** کاربری که حساب کاربری ندارد، **When** فرم ثبت‌نام را با نام کاربری، ایمیل معتبر و رمز عبور قوی پر می‌کند، **Then** حساب کاربری با نقش "کاربر عادی" ایجاد می‌شود و کاربر می‌تواند وارد سیستم شود
2. **Given** کاربری در حال ثبت‌نام است، **When** ایمیل تکراری وارد می‌کند، **Then** سیستم پیام خطای مناسب به فارسی نمایش می‌دهد ("این ایمیل قبلاً ثبت شده است")
3. **Given** کاربری در حال ثبت‌نام است، **When** رمز عبور ضعیف وارد می‌کند، **Then** سیستم الزامات رمز عبور را به فارسی نمایش می‌دهد
4. **Given** کاربری در حال ثبت‌نام است، **When** فیلدهای اجباری را خالی می‌گذارد، **Then** سیستم پیام‌های خطای مناسب به فارسی نمایش می‌دهد

---

### User Story 2 - ورود کاربر (User Login) (Priority: P1)

کاربر ثبت‌شده باید بتواند با استفاده از اطلاعات کاربری خود (ایمیل و رمز عبور) وارد سیستم شود و به قابلیت‌های سیستم دسترسی پیدا کند. سیستم باید بتواند کاربر را شناسایی کرده و نقش او (ادمین یا کاربر عادی) را تشخیص دهد.

**Why this priority**: بدون قابلیت ورود، کاربران ثبت‌شده نمی‌توانند از سیستم استفاده کنند. این قابلیت برای تأیید هویت کاربر ضروری است.

**Independent Test**: می‌توان با ایجاد فرم ورود و اعتبارسنجی اطلاعات کاربر در برابر داده‌های ذخیره‌شده، این قابلیت را تست کرد. موفقیت در ورود با دسترسی به صفحه اصلی سیستم قابل سنجش است.

**Acceptance Scenarios**:

1. **Given** کاربری با حساب کاربری معتبر، **When** ایمیل و رمز عبور صحیح را وارد می‌کند، **Then** وارد سیستم می‌شود و به داشبورد مربوط به نقش خود دسترسی پیدا می‌کند
2. **Given** کاربری در حال ورود است، **When** ایمیل یا رمز عبور اشتباه وارد می‌کند، **Then** سیستم پیام خطای مناسب به فارسی نمایش می‌دهد ("ایمیل یا رمز عبور نادرست است")
3. **Given** کاربری با نقش "ادمین" وارد سیستم شده است، **When** به داشبورد دسترسی پیدا می‌کند، **Then** می‌تواند تمام پروژه‌ها و تسک‌های سیستم را مشاهده و مدیریت کند
4. **Given** کاربری با نقش "کاربر عادی" وارد سیستم شده است، **When** به داشبورد دسترسی پیدا می‌کند، **Then** فقط پروژه‌ها و تسک‌های مربوط به خود را می‌بیند
5. **Given** کاربری در حال ورود است، **When** فیلدهای اجباری را خالی می‌گذارد، **Then** سیستم پیام‌های خطای مناسب به فارسی نمایش می‌دهد

---

### User Story 3 - بازیابی رمز عبور (Password Recovery) (Priority: P2)

کاربری که رمز عبور خود را فراموش کرده است، باید بتواند درخواست بازیابی رمز عبور دهد. سیستم باید فرآیندی امن برای تنظیم مجدد رمز عبور فراهم کند.

**Why this priority**: فراموشی رمز عبور یک مشکل رایج است که می‌تواند دسترسی کاربران به سیستم را مسدود کند. این قابلیت تجربه کاربری را بهبود می‌بخشد.

**Independent Test**: می‌توان با ایجاد فرم بازیابی رمز عبور و ارسال لینک بازیابی، این قابلیت را تست کرد. موفقیت با توانایی کاربر در تنظیم رمز عبور جدید و ورود به سیستم قابل سنجش است.

**Acceptance Scenarios**:

1. **Given** کاربری که رمز عبور خود را فراموش کرده است، **When** ایمیل خود را در فرم بازیابی وارد می‌کند، **Then** لینک بازیابی رمز عبور به ایمیل او ارسال می‌شود
2. **Given** کاربری که لینک بازیابی دریافت کرده است، **When** روی لینک کلیک می‌کند و رمز عبور جدید را وارد می‌کند، **Then** رمز عبور او تغییر می‌کند و می‌تواند با رمز عبور جدید وارد شود
3. **Given** کاربری در حال بازیابی رمز عبور است، **When** ایمیلی که در سیستم ثبت نشده وارد می‌کند، **Then** سیستم به دلایل امنیتی پیام عمومی نمایش می‌دهد ("اگر ایمیل شما در سیستم ثبت باشد، لینک بازیابی ارسال می‌شود")
4. **Given** کاربری که لینک بازیابی دریافت کرده است، **When** بعد از مدت زمان مشخصی (مثلاً 1 ساعت) از لینک استفاده می‌کند، **Then** سیستم پیام می‌دهد که لینک منقضی شده و باید درخواست جدیدی ارسال کند

---

### User Story 4 - خروج از سیستم (Logout) (Priority: P2)

کاربر وارد شده باید بتواند از سیستم خارج شود و نشست خود را پایان دهد.

**Why this priority**: قابلیت خروج برای امنیت و مدیریت نشست‌های کاربری ضروری است، اما نسبت به ورود و ثبت‌نام اولویت کمتری دارد.

**Independent Test**: می‌توان با افزودن دکمه خروج و پایان دادن به نشست کاربر، این قابلیت را تست کرد. موفقیت با بازگشت به صفحه ورود و عدم دسترسی به منابع محافظت‌شده قابل سنجش است.

**Acceptance Scenarios**:

1. **Given** کاربری که وارد سیستم شده است، **When** دکمه خروج را می‌زند، **Then** نشست او پایان می‌یابد و به صفحه ورود بازمی‌گردد
2. **Given** کاربری که از سیستم خارج شده است، **When** سعی می‌کند به صفحات محافظت‌شده دسترسی پیدا کند، **Then** به صفحه ورود هدایت می‌شود

---

### User Story 5 - مدیریت کاربران توسط ادمین (User Management by Admin) (Priority: P3)

ادمین باید بتواند لیست تمام کاربران را مشاهده کند، نقش کاربران را تغییر دهد، و در صورت نیاز کاربران را غیرفعال کند.

**Why this priority**: قابلیت مدیریت کاربران برای کنترل دسترسی‌ها مهم است، اما پس از ایجاد قابلیت‌های اصلی احراز هویت می‌تواند پیاده‌سازی شود.

**Independent Test**: می‌توان با ایجاد صفحه مدیریت کاربران برای ادمین، این قابلیت را تست کرد. موفقیت با توانایی ادمین در تغییر نقش یا غیرفعال کردن کاربر قابل سنجش است.

**Acceptance Scenarios**:

1. **Given** ادمینی که وارد سیستم شده است، **When** به صفحه مدیریت کاربران می‌رود، **Then** لیست تمام کاربران با نقش‌های آن‌ها را می‌بیند
2. **Given** ادمینی در صفحه مدیریت کاربران است، **When** نقش یک کاربر را از "کاربر عادی" به "ادمین" تغییر می‌دهد، **Then** نقش کاربر به‌روزرسانی می‌شود و کاربر دسترسی‌های ادمین را پیدا می‌کند
3. **Given** ادمینی در صفحه مدیریت کاربران است، **When** یک کاربر را غیرفعال می‌کند، **Then** کاربر نمی‌تواند وارد سیستم شود

---

### Edge Cases

- چه اتفاقی می‌افتد وقتی کاربر چندین بار پشت سر هم رمز عبور اشتباه وارد می‌کند؟ (سیستم باید پس از تعداد مشخصی (مثلاً 5 بار) تلاش ناموفق، حساب را به طور موقت قفل کند)
- چه اتفاقی می‌افتد وقتی کاربر درخواست بازیابی رمز عبور را چندین بار پشت سر هم ارسال می‌کند؟ (سیستم باید محدودیت زمانی برای درخواست‌های متعدد اعمال کند)
- چه اتفاقی می‌افتد وقتی دو کاربر همزمان با یک حساب کاربری وارد سیستم می‌شوند؟ (سیستم باید چند نشست همزمان را پشتیبانی کند یا نشست قبلی را باطل کند)
- چه اتفاقی می‌افتد وقتی نشست کاربر منقضی می‌شود؟ (کاربر باید به صفحه ورود هدایت شود با پیام مناسب)
- چگونه سیستم با حملات brute force مقابله می‌کند؟ (محدودیت تعداد تلاش‌های ورود، CAPTCHA بعد از تلاش‌های ناموفق)

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: سیستم باید فرم ثبت‌نام با فیلدهای نام کاربری، ایمیل، رمز عبور و تکرار رمز عبور داشته باشد که تمام برچسب‌ها به زبان فارسی باشند
- **FR-002**: سیستم باید فرم ورود با فیلدهای ایمیل و رمز عبور داشته باشد که تمام برچسب‌ها به زبان فارسی باشند
- **FR-003**: سیستم باید فرم بازیابی رمز عبور با فیلد ایمیل داشته باشد که تمام برچسب‌ها به زبان فارسی باشند
- **FR-004**: سیستم باید دو نقش کاربری را پشتیبانی کند: "ادمین" و "کاربر عادی"
- **FR-005**: سیستم باید هنگام ثبت‌نام، کاربران جدید را به طور پیش‌فرض با نقش "کاربر عادی" ایجاد کند
- **FR-006**: سیستم باید ایمیل‌های تکراری را شناسایی کرده و از ثبت آن‌ها جلوگیری کند
- **FR-007**: سیستم باید رمز عبور را با الزامات امنیتی اعتبارسنجی کند (حداقل 8 کاراکتر، شامل حروف بزرگ و کوچک، اعداد)
- **FR-008**: سیستم باید رمزهای عبور را به صورت امن ذخیره کند (هش شده، نه به صورت متن ساده)
- **FR-009**: سیستم باید پس از ورود موفق، نشست کاربری ایجاد کند و هویت کاربر را در تمام درخواست‌ها حفظ کند
- **FR-010**: سیستم باید کاربر با نقش "ادمین" را به تمام منابع سیستم (پروژه‌ها، تسک‌ها، تایم‌لاگ‌ها) دسترسی دهد
- **FR-011**: سیستم باید کاربر با نقش "کاربر عادی" را فقط به منابع مربوط به خودش دسترسی دهد
- **FR-012**: سیستم باید برای بازیابی رمز عبور، لینک یکبار مصرف با زمان انقضای مشخص (1 ساعت) ایجاد کند
- **FR-013**: سیستم باید لینک بازیابی رمز عبور را به ایمیل کاربر ارسال کند
- **FR-014**: سیستم باید فرآیند خروج را پشتیبانی کند و نشست کاربر را پایان دهد
- **FR-015**: سیستم باید ادمین را قادر به مشاهده لیست تمام کاربران کند
- **FR-016**: سیستم باید ادمین را قادر به تغییر نقش کاربران کند
- **FR-017**: سیستم باید ادمین را قادر به غیرفعال کردن کاربران کند
- **FR-018**: سیستم باید حساب کاربری را پس از 5 بار ورود ناموفق به مدت 15 دقیقه قفل کند
- **FR-019**: سیستم باید تمام پیام‌های خطا و اعلان‌ها را به زبان فارسی نمایش دهد
- **FR-020**: سیستم باید نشست‌های منقضی شده را شناسایی کرده و کاربر را به صفحه ورود هدایت کند

### Key Entities

- **کاربر (User)**: نمایانگر یک فرد استفاده‌کننده از سیستم. ویژگی‌های کلیدی شامل شناسه یکتا، نام کاربری، ایمیل (یکتا)، رمز عبور (هش شده)، نقش (ادمین یا کاربر عادی)، وضعیت (فعال/غیرفعال)، تاریخ ثبت‌نام، و تاریخ آخرین ورود است.

- **نقش (Role)**: تعیین‌کننده سطح دسترسی کاربر. دو نقش وجود دارد:
  - **ادمین**: دسترسی کامل به تمام منابع سیستم، قابلیت مدیریت کاربران، پروژه‌ها، تسک‌ها و تایم‌لاگ‌های تمام کاربران
  - **کاربر عادی**: دسترسی محدود به منابع مربوط به خود، نمی‌تواند کاربران دیگر را مدیریت کند یا به داده‌های آن‌ها دسترسی داشته باشد

- **نشست (Session)**: نمایانگر یک دوره فعالیت کاربر در سیستم. ویژگی‌های کلیدی شامل شناسه نشست، شناسه کاربر، زمان ایجاد، زمان انقضا، و وضعیت (فعال/منقضی) است.

- **توکن بازیابی رمز عبور (Password Reset Token)**: نمایانگر یک درخواست بازیابی رمز عبور. ویژگی‌های کلیدی شامل توکن یکتا، شناسه کاربر، زمان ایجاد، زمان انقضا (1 ساعت)، و وضعیت (استفاده‌شده/استفاده‌نشده) است.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: کاربران باید بتوانند فرآیند ثبت‌نام را در کمتر از 2 دقیقه کامل کنند
- **SC-002**: کاربران باید بتوانند در کمتر از 30 ثانیه وارد سیستم شوند
- **SC-003**: 90% از کاربران باید در اولین تلاش، فرآیند ثبت‌نام یا ورود را با موفقیت انجام دهند
- **SC-004**: فرآیند بازیابی رمز عبور باید در کمتر از 5 دقیقه (از درخواست تا دریافت ایمیل) انجام شود
- **SC-005**: سیستم باید حداقل 100 کاربر همزمان را بدون کاهش کارایی پشتیبانی کند
- **SC-006**: تمام فرم‌ها و پیام‌های سیستم باید 100% به زبان فارسی باشند
- **SC-007**: نرخ خطای هنگام ورود باید کمتر از 5% باشد (به دلیل ورود اطلاعات نادرست توسط کاربر)
- **SC-008**: زمان پاسخ برای عملیات احراز هویت (ورود، ثبت‌نام) باید کمتر از 2 ثانیه باشد
- **SC-009**: سیستم باید 95% از حملات brute force را با استفاده از مکانیزم‌های امنیتی شناسایی و مسدود کند

## Assumptions

- فرض بر این است که سیستم به یک سرویس ایمیل برای ارسال لینک‌های بازیابی رمز عبور دسترسی دارد
- فرض بر این است که کاربران به ایمیل معتبر دسترسی دارند و می‌توانند ایمیل‌های سیستم را دریافت کنند
- فرض بر این است که اولین کاربر ثبت‌شده یا یک کاربر پیش‌فرض با نقش "ادمین" وجود دارد (برای مدیریت کاربران اولیه)
- فرض بر این است که سیستم در ابتدا برای تعداد محدودی از کاربران (حداکثر 1000 کاربر) طراحی می‌شود
- فرض بر این است که کاربران از مرورگرهای مدرن استفاده می‌کنند که از کوکی‌ها و ذخیره‌سازی محلی پشتیبانی می‌کنند
